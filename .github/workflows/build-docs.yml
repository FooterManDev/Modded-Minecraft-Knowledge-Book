name: Build

on:
  push:
    branches: ["master"]
  workflow_dispatch:

env:
  INSTANCE: 'Writerside/1'
  DOCKER_VERSION: '243.22562'
  CF_ACC_ID: ${{ secrets.CF_ACC_ID }}
  CF_API_TOK: ${{ secrets.CF_API_TOK }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      zip_path: ${{ steps.discover.outputs.zip_path  }}
      build_dir: ${{ steps.extract.outputs.build_dir }}

    steps:
      - uses: actions/checkout@v4

      - name: Writerside Build
        uses: JetBrains/writerside-github-action@v4
        with:
          instance: ${{ env.INSTANCE }}
          docker-version: ${{ env.DOCKER_VERSION }}

      - name: Discover Build Artifacts
        id: discover
        run: |
          echo "Workspace contents:"
          find . -type f -maxdepth 3 | sed 's/^/  /'
          ZIP_PATH=$(find artifacts -type f -name '*.zip' | head -n 1)
          if [ -z "$ZIP_PATH" ]; then
            echo "❌ No ZIP found under artifacts/—check Writerside action output!"
            exit 1
          fi
          BUILD_DIR="${ZIP_PATH%.zip}"
          echo "Found ZIP: $ZIP_PATH"
          echo "Derived build_dir: $BUILD_DIR"
          echo "zip_path=$ZIP_PATH" >> "$GITHUB_OUTPUT"
          echo "build_dir=$BUILD_DIR" >> "$GITHUB_OUTPUT"

      - name: Upload Built
        uses: actions/upload-artifact@v4
        with:
          name: zip
          path: ${{ steps.discover.outputs.zip_path }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Build
        uses: actions/download-artifact@v4
        with:
          name: zip
          path: .

      - name: Unzip Writerside output
        run: |
          ZIP="${{ needs.build.outputs.zip_path }}"
          DEST="${{ needs.build.outputs.build_dir }}"
          mkdir -p "$DEST"
          unzip "$ZIP" -d "$DEST"

      - name: Deploy to CF
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ env.CF_API_TOK }}
          accountId: ${{ env.CF_ACC_ID }}
          command: pages deploy --project-name=mmkb
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}